HrDashboard=window.HrDashboard||{},function(){function o(){n.clearFilters();n.isLoading(!1)}function s(t,i){if(n.allEmployeesEnumerable&&!i){t(null,n.allEmployeesEnumerable);return}var r=[];SDK.JQuery.retrieveMultipleRecords("ihr_employee","$select=ihr_employeeId,ihr_StartDate,ihr_EndDate,ihr_Office,ihr_Pulse,ihr_ManagerId,ihr_EmployeeStatus,statecode,statuscode,ihr_Group,ihr_fullname,ihr_ihr_employee_ihr_employeetrail,ihr_ihr_employee_ihr_benefit&$expand=ihr_ihr_employee_ihr_employeetrail,ihr_ihr_employee_ihr_benefit",function(n){r=r.concat(n)},function(n){t(n,null)},function(){var i=Enumerable.From(r);n.allEmployeesEnumerable=i;t(null,i)})}function h(t,i){if(n.employeeMetadata&&!i){t(null,n.employeeMetadata);return}SDK.Metadata.RetrieveEntity(SDK.Metadata.EntityFilters.Attributes,"ihr_employee",null,!1,function(i){n.employeeMetadata=i;t(null,i)},function(n){t(n,null)})}function c(t,i){if(n.employeeTrailMetadata&&!i){t(null,n.employeeTrailMetadata);return}SDK.Metadata.RetrieveEntity(SDK.Metadata.EntityFilters.Attributes,"ihr_employeetrail",null,!1,function(i){n.employeeTrailMetadata=i;t(null,i)},function(n){t(n,null)})}function l(t,i){var e,o,u;if(n.allEventsEnumerable&&!i){t(null,n.allEventsEnumerable);return}var s=moment(),r=s.clone().startOf("day").startOf("month").subtract(3,"months"),c="datetime'"+r.format("YYYY-MM-DD")+"T"+r.format("HH:mm:ss")+"Z'",f=s.clone().endOf("day").startOf("month").add(2,"months").endOf("month").endOf("day"),l="datetime'"+f.format("YYYY-MM-DD")+"T"+f.format("HH:mm:ss")+"Z'",h=[r.clone()];for(e=1;;e++){if(o=r.clone().add(e,"months"),o.isAfter(f))break;h.push(o)}n.eventMonths=h;u=[];SDK.JQuery.retrieveMultipleRecords("ihr_event","$select=ihr_Date,ihr_Type,ihr_eventId,ihr_IsSocialEvent,ihr_IsTouchpoint,ihr_ihr_employee_ihr_event&$expand=ihr_ihr_employee_ihr_event&$filter=ihr_Date ge "+c+" and ihr_Date le "+l,function(n){u=u.concat(n)},function(n){t(n,null)},function(){var i=Enumerable.From(u);n.allEventsEnumerable=i;t(null,n.allEventsEnumerable)})}function a(t,i){if(n.eventMetadata&&!i){t(null,n.eventMetadata);return}SDK.Metadata.RetrieveEntity(SDK.Metadata.EntityFilters.Attributes,"ihr_event",null,!1,function(i){n.eventMetadata=i;t(null,i)},function(n){t(n,null)})}function v(t,i){if(n.taskMetadata&&!i){t(null,n.taskMetadata);return}SDK.Metadata.RetrieveEntity(SDK.Metadata.EntityFilters.Attributes,"Task",null,!1,function(i){n.taskMetadata=i;t(null,i)},function(n){t(n,null)})}function y(t,i,r){if(n.allTasksEnumerable&&!i){t(null,n.allTasksEnumerable);return}var f=Enumerable.From(Enumerable.From(r.Attributes).Where('$.SchemaName === "StateCode"').Single().OptionSet.Options).Single('$.Label.UserLocalizedLabel.Label == "Open"').Value,u=[];SDK.JQuery.retrieveMultipleRecords("Task","$select=ActivityId,Subject,StateCode,RegardingObjectId&$filter=RegardingObjectId ne null and StateCode/Value eq "+f+"&$orderby=CreatedOn",function(n){u=u.concat(n)},function(n){t(n,null)},function(){var i=Enumerable.From(u);n.allTasksEnumerable=i;t(null,n.allTasksEnumerable)})}function p(t,i){if(n.benefitOptionsEnumerable&&!i){t(null,n.benefitOptionsEnumerable);return}var r=[];SDK.JQuery.retrieveMultipleRecords("ihr_benefit","$select=ihr_name,ihr_Rank&$orderby=ihr_Rank&$top=3",function(n){r=r.concat(n)},function(n){t(n,null)},function(){var i=[{divId:"benefits1",benefitName:"MultiSport",color:"#77c06e"},{divId:"benefits2",benefitName:"LUX MED",color:"#64c6e9"},{divId:"benefits3",benefitName:"Life Insurance",color:"#ec7652"}],u=Enumerable.From(r).Take(i.length).Select(function(n,t){var r=i[t];return r.benefitName=n.ihr_name,r}).ToArray();n.benefitOptionsEnumerable=Enumerable.From(u);t(null,n.benefitOptionsEnumerable)})}function w(i){var r=[new t("No manager",null)].concat(i.GroupBy(function(n){return n.ihr_ManagerId},function(n){return{id:n.ihr_ManagerId.Id}},function(n){return new t(n.Name?n.Name:"No manager",n.Id)},function(n){return n.Id}).Where("$.id() !== null").ToArray());n.managerFilter().options(r)}function b(i){var f=Enumerable.From(i.Attributes).Where(function(n){return n.SchemaName=="ihr_Office"}).Single(),e=[new t("No office",null)].concat(Enumerable.From(f.OptionSet.Options).Select(function(n){return new t(n.Label.UserLocalizedLabel.Label,n.Value)}).ToArray()),r,u;n.officeFilter().options(e);r=Enumerable.From(i.Attributes).Where(function(n){return n.SchemaName=="ihr_Group"}).Single();u=[new t("No group",null)].concat(Enumerable.From(r.OptionSet.Options).Select(function(n){return new t(n.Label.UserLocalizedLabel.Label,n.Value)}).ToArray());n.groupFilter().options(u)}function k(t){var i=Enumerable.From(t.Attributes).Where(function(n){return n.SchemaName=="ihr_Pulse"}).Single(),r=Enumerable.From([{name:"Not Assessed",color:"#e3e3e3"},{name:"Green",color:"#77c06e"},{name:"Yellow",color:"#faf858"},{name:"Orange",color:"#f6c35a"},{name:"Red",color:"#ec7652"}]),u=Enumerable.From(i.OptionSet.Options).Select(function(n){var t=r.FirstOrDefault(null,function(t){return t.name===n.Label.UserLocalizedLabel.Label}),i="#"+Math.floor(Math.random()*16777215).toString(16);return t&&(i=t.color),{name:n.Label.UserLocalizedLabel.Label,value:n.Value,color:i}}).ToArray();n.pulseOptionsEnumerable=Enumerable.From(u)}function d(t){var i=Enumerable.From(t.Attributes).Where(function(n){return n.SchemaName=="ihr_Type"}).Single(),r=Enumerable.From([{name:"Conference",color:"#77c06e"},{name:"Executive Lunch/Dinner",color:"#b0d56e"},{name:"Gift",color:"#ec7652"},{name:"Offsite/Retreat",color:"#f6c35a"},{name:"Lunch & Learn",color:"#64c6e9"},{name:"One-on-one",color:"#64c6e9"},{name:"Promotion",color:"#f6c35a"},{name:"Social Gathering",color:"#ec7652"},{name:"Tech. Night",color:"#b0d56e"},{name:"Training",color:"#77c06e"}]),u=Enumerable.From(i.OptionSet.Options).Select(function(n){var t=r.FirstOrDefault(null,function(t){return t.name===n.Label.UserLocalizedLabel.Label}),i="#"+Math.floor(Math.random()*16777215).toString(16);return t&&(i=t.color),{name:n.Label.UserLocalizedLabel.Label,value:n.Value,color:i}}).ToArray();n.eventTypesEnumerable=Enumerable.From(u)}function g(t,i,r,u){var e=Enumerable.From(Enumerable.From(i.Attributes).Where('$.SchemaName === "statecode"').Single().OptionSet.Options).Single('$.Label.UserLocalizedLabel.Label == "Active"').Value,f=Enumerable.From(Enumerable.From(r.Attributes).Where('$.SchemaName === "statecode"').Single().OptionSet.Options).Single('$.Label.UserLocalizedLabel.Label == "Active"').Value;n.allEmployees=t.Select(function(n){var o=Enumerable.From(n.ihr_ihr_employee_ihr_benefit.results).Select("$.ihr_name").ToArray(),r=Enumerable.From(n.ihr_ihr_employee_ihr_employeetrail.results),i=r.FirstOrDefault(null,'$.ihr_name == "Start" && $.statecode.Value == '+f),s=i!=null&&i.ihr_Date!=null?moment({y:i.ihr_Date.getFullYear(),M:i.ihr_Date.getMonth(),d:i.ihr_Date.getDate()}):null,t=r.FirstOrDefault(null,'$.ihr_name == "End" && $.statecode.Value == '+f),h=t!=null&&t.ihr_Date!=null?moment({y:t.ihr_Date.getFullYear(),M:t.ihr_Date.getMonth(),d:t.ihr_Date.getDate()}):null,c=u.Where(function(t){return t.ihr_Date!=null&&Enumerable.From(t.ihr_ihr_employee_ihr_event.results).Any("$.ihr_employeeId === '"+n.ihr_employeeId+"'")}).Select(function(n){return new it(n.ihr_eventId,moment({y:n.ihr_Date.getFullYear(),M:n.ihr_Date.getMonth(),d:n.ihr_Date.getDate()}),n.ihr_Type.Value,n.ihr_IsSocialEvent,n.ihr_IsTouchpoint)}).ToArray();return new tt(n.ihr_employeeId,n.ihr_fullname,n.ihr_ManagerId.Id,n.ihr_Group.Value,n.ihr_Office.Value,n.ihr_Pulse.Value,n.statecode.Value===e,o,s,h,t!=null?t.ihr_Reason==="Voluntary":!1,c)}).ToArray();n.allActiveEmployees=Enumerable.From(n.allEmployees).Where("$.isActive").ToArray()}function nt(t){n.allTasks=t.Where("$.RegardingObjectId.LogicalName == 'ihr_employee'").Select(function(n){return new rt(n.ActivityId,n.Subject,n.RegardingObjectId.Id)}).ToArray();n.allActiveEmployees=Enumerable.From(n.allEmployees).Where("$.isActive").ToArray()}function r(n,t){var i=this;i.filterName=n;i.name=ko.observable(n);i.options=ko.observableArray([]);i.selectedId=ko.observable("NA");i.selectedIdStr=ko.observable();i.filterFunction=function(n){return i.selectedId()==="NA"||i.selectedId()===t(n)};i.setOption=function(n){var t=$.grep(i.options(),function(t){return t.name()===n})[0];t&&(i.reset(),i.name(n),t.isActive(!0),$(".filter-select").removeClass("active"),i.selectedId(t.id()),i.selectedIdStr(""+t.id()))};i.reset=function(){i.name(i.filterName);i.selectedId("NA");i.selectedIdStr("");$.each(i.options(),function(n,t){t.isActive(!1)})}}function t(n,t){var i=this;i.name=ko.observable(n);i.id=ko.observable(t);i.isActive=ko.observable(!1)}function tt(n,t,i,r,u,f,e,o,s,h,c,l){var a=this;a.id=n;a.name=t;a.managerId=i;a.groupId=r;a.pulseId=f;a.officeId=u;a.isActive=e;a.benefits=o;a.startDate=s;a.endDate=h;a.endVoluntary=c;a.events=l?l:[]}function it(n,t,i,r,u){var f=this;f.id=n;f.date=t;f.dateDesc=t.format("MMMYY");f.typeId=i;f.isSocial=r;f.isTouchpoint=u}function rt(n,t,i){var r=this;r.id=n;r.subject=t;r.employeeId=i}function u(n,t,i){var r=this;r.name=ko.observable(n);r.value=ko.observable("?");r.from=t;r.to=i;r.lastEmployees=[];r.update=function(n){if(n||(n=r.lastEmployees),r.lastEmployees=n,n&&r.from&&r.to&&r.from.isValid()&&r.to.isValid()){var t=Enumerable.From(n).Count(function(n){return n.startDate!==null&&(n.startDate.isBefore(r.from)||n.startDate.isSame(r.from,"day"))&&(n.endDate===null||n.endDate.isAfter(r.from))}),i=Enumerable.From(n).Count(function(n){return n.startDate!==null&&(n.startDate.isBefore(r.to)||n.startDate.isSame(r.to,"day"))&&(n.endDate===null||n.endDate.isAfter(r.to))}),u=Enumerable.From(n).Count(function(n){return n.endVoluntary&&n.endDate!=null&&(n.endDate.isAfter(r.from)||n.endDate.isSame(r.from))&&(n.endDate.isBefore(r.to)||n.endDate.isSame(r.to))}),f=t+i>0?Math.round(200*u/(t+i)):"?";r.value(f)}};r.updateCustom=function(n,t){r.from=n;r.to=t;r.name(""+n.format("DD/MM/YY")+" - "+t.format("DD/MM/YY"));r.update()}}function ut(){var n=this,t=moment(),r=moment({y:t.year(),M:i-1,d:1}),f;r.isAfter(t)&&(r=r.subtract(1,"years"));n.YTD=new u("YTD",r,t.clone());n.custom=new u("",null,null);n.custom.updateCustom(t.clone().subtract(1,"months"),t.clone());f=t.clone().subtract(i-1,"months").quarter();n.quarters=ko.observable(Enumerable.Range(0,4).Select(function(n){var r=moment([t.year(),(f-1)*3,1]).subtract((13-i)%12,"months").subtract(n*3,"months"),e=r.clone().add(2,"months").endOf("month"),o=moment([t.year(),(f-1)*3,1]).subtract(n*3,"months").format("YY"),s=r.clone().subtract(i-1,"months").quarter();return e.isAfter(t)&&(e=t.clone()),new u("FY"+o+" Q"+s,r,e)}).ToArray());n.allTurnovers=[n.YTD,n.custom].concat(n.quarters());n.customFrom=ko.observable(n.custom.from.format("DD/MM/YY"));n.customTo=ko.observable(n.custom.to.format("DD/MM/YY"));n.customUpdate=function(){var t=moment(n.customFrom(),"DD/MM/YY"),i=moment(n.customTo(),"DD/MM/YY");t.isValid()&&i.isValid()&&(t.isBefore(i)||t.isSame(i))&&n.custom.updateCustom(t,i)};n.updateAll=function(t){$.each(n.allTurnovers,function(n,i){i.update(t)})}}function f(n,t,i,r,u,f){var e=this;e.name=n;e.url=t;e.title=i;e.isRed=r;e.isOrange=u;e.isTask=f}function ft(){var t=n.filteredActiveEmployees(),i=t.length,r=i>0?Enumerable.From(t).GroupBy("$.pulseId").Select(function(t){var r=n.pulseOptionsEnumerable.Single(function(n){return t.Key()===n.value});return{collectionAlias:r.name,y:parseFloat((t.source.length*100/i).toFixed(1)),pointName:""+t.source.length,color:r.color}}).ToArray():[];$("#pulse").shieldChart({exportOptions:{image:!1,print:!1},primaryHeader:{text:"Pulse"},seriesSettings:{donut:{enablePointSelection:!0}},tooltipSettings:{customPointText:"{point.collectionAlias}: {point.pointName} | {point.y}%"},seriesPalette:Enumerable.From(r).Select("$.color").ToArray(),dataSeries:[{seriesType:"donut",collectionAlias:"Pulse",data:r}]})}function et(){var i=n.filteredActiveEmployees(),t=i.length;n.benefitOptionsEnumerable.ForEach(function(n){var r=Enumerable.From(i).Count(function(t){return $.inArray(n.benefitName,t.benefits)!==-1}),u=t>0?[{collectionAlias:"Not assigned",y:parseFloat(((t-r)*100/t).toFixed(1)),pointName:""+(t-r),color:"#e3e3e3"},{collectionAlias:n.benefitName,y:parseFloat((r*100/t).toFixed(1)),pointName:""+r,color:n.color}]:[];$("#"+n.divId).shieldChart({exportOptions:{image:!1,print:!1},primaryHeader:{text:"Benefits"},seriesSettings:{donut:{enablePointSelection:!0}},tooltipSettings:{customPointText:"{point.collectionAlias}: {point.pointName} | {point.y}%"},seriesPalette:["#e3e3e3",n.color],dataSeries:[{seriesType:"donut",collectionAlias:n.benefitName,data:u}]})})}function e(t,i,r){var o=n.filteredActiveEmployees(),u=Enumerable.From(o).SelectMany("$.events").Distinct("$.id").Where(r).ToArray(),f=Enumerable.From(u).Select("$.typeId").Distinct().Select(function(t){return n.eventTypesEnumerable.First("$.value == "+t)}).ToArray(),s=Enumerable.From(u),e=Enumerable.From(n.eventMonths),h=Enumerable.From(f).Select(function(n){var t=e.Select(function(t){var i=t.clone().endOf("month").endOf("day");return s.Where("$.typeId == "+n.value).Count(function(n){return(n.date.isSame(t)||n.date.isAfter(t))&&(n.date.isSame(i)||n.date.isBefore(i))})}).ToArray();return{seriesType:"bar",collectionAlias:n.name,data:t}}).ToArray();$("#"+t).shieldChart({exportOptions:{image:!1,print:!1},seriesSettings:{bar:{stackMode:"normal"}},axisX:{drawColor:"transparent",ticksColor:"transparent",categoricalValues:e.Select(function(n){return n.format("MMMYY")}).ToArray()},primaryHeader:{text:i},chartLegend:{enabled:!1},seriesPalette:Enumerable.From(f).Select("$.color").ToArray(),dataSeries:h})}function ot(){var t=Enumerable.From(n.filteredActiveEmployees()),i=t.Where("$.pulseId == '"+n.pulseOptionsEnumerable.First("$.name == 'Red'").value+"'").Select(function(n){return new f(n.name,n.id,"Red Pulse",!0,!1,!1)}),r=t.Where("$.pulseId == '"+n.pulseOptionsEnumerable.First("$.name == 'Orange'").value+"'").Select(function(n){return new f(n.name,n.id,"Orange Pulse",!1,!0,!1)}),u=Enumerable.From(n.allTasks),e=u.Join(t,"$.employeeId","$.id",function(n,t){return new f(t.name,n.id,n.subject,!1,!1,!0)}),o=i.Concat(r).Concat(e).ToArray();n.followUps(o)}var n=this,i=11;n.allEmployeesEnumerable=null;n.employeeMetadata=null;n.employeeTrailMetadata=null;n.allEventsEnumerable=null;n.eventMetadata=null;n.pulseOptionsEnumerable=null;n.benefitOptionsEnumerable=null;n.eventTypesEnumerable=null;n.eventMonths=[];n.allEmployees=[];n.filteredAllEmployees=ko.observable([]);n.allActiveEmployees=[];n.filteredActiveEmployees=ko.observable([]);n.taskMetadata=null;n.allTasksEnumerable=null;n.allTasks=[];n.isLoading=ko.observable(!1);n.refresh=function(t){n.isLoading(!0);async.auto({employees:function(n){s(n,t)},employeeMetadata:function(n){h(n,t)},employeeTrailMetadata:function(n){c(n,t)},events:function(n){l(n,t)},eventMetadata:function(n){a(n,t)},taskMetadata:function(n){v(n,t)},tasks:["taskMetadata",function(n,i){y(n,t,i.taskMetadata)}],benefitOptions:function(n){p(n,t)},managerFilter:["employees",function(n,t){w(t.employees);n()}],officeAndGroupFilter:["employeeMetadata",function(n,t){b(t.employeeMetadata);n()}],initializePulseOptions:["employeeMetadata",function(n,t){k(t.employeeMetadata);n()}],initializeEventOptions:["eventMetadata",function(n,t){d(t.eventMetadata);n()}],initializeTasks:["tasks","taskMetadata",function(n,t){nt(t.tasks,t.taskMetadata);n()}],initializeEmployees:["employees","employeeMetadata","employeeTrailMetadata","events","benefitOptions","initializePulseOptions","initializeEventOptions",function(n,t){g(t.employees,t.employeeMetadata,t.employeeTrailMetadata,t.events);n()}],finish:["initializeEmployees","initializeTasks",function(n){o();n()}]},function(n){n&&alert(n)})};n.managerFilter=ko.observable(new r("Manager",function(n){return n.managerId}));n.filterByManager=function(t){n.managerFilter().setOption(t.name())};n.groupFilter=ko.observable(new r("Group",function(n){return n.groupId}));n.filterByGroup=function(t){n.groupFilter().setOption(t.name())};n.officeFilter=ko.observable(new r("Office",function(n){return n.officeId}));n.filterByOffice=function(t){n.officeFilter().setOption(t.name())};n.filters=[n.managerFilter,n.groupFilter,n.officeFilter];n.clearFilters=function(){$.each(n.filters,function(n,t){t().reset()})};n.computedFilters=ko.computed(function(){return n.managerFilter().selectedIdStr()+"|"+n.groupFilter().selectedIdStr()+"|"+n.officeFilter().selectedIdStr()}).extend({throttle:100});n.computedFilters.subscribe(function(){var t=Enumerable.From(n.filters),r=Enumerable.From(n.allActiveEmployees).Where(function(n){return t.All(function(t){return t().filterFunction(n)})}).ToArray(),i;n.filteredActiveEmployees(r);i=Enumerable.From(n.allEmployees).Where(function(n){return t.All(function(t){return t().filterFunction(n)})}).ToArray();n.filteredAllEmployees(i)});n.filteredActiveEmployeesThrottled=ko.computed(n.filteredActiveEmployees).extend({throttle:100});n.filteredActiveEmployeesThrottled.subscribe(function(){ft();et();e("socialevents","Social Events","$.isSocial");e("touchpoints","Touch Points","$.isTouchpoint");ot()});n.filteredAllEmployeesThrottled=ko.computed(n.filteredAllEmployees).extend({throttle:100});n.filteredAllEmployeesThrottled.subscribe(function(){n.turnovers().updateAll(n.filteredAllEmployees())});n.turnovers=ko.observable(new ut);n.followUps=ko.observableArray([])}.call(HrDashboard);
